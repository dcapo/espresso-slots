<template>
    <div class="slot-machine">
        <div class="slot-machine__marquee">
            <star class="slot-machine__marquee__star"></star>
            <div class="slot-machine__marquee__message">
                <svg width="236px" height="37px" viewBox="0 0 236 37" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                    <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                        <path d="M137.010754,17.8793131 C136.290709,17.0150581 135.254221,16.5773414 133.928777,16.5773414 C131.09247,16.5773414 127.761902,19.1242168 126.883928,23.9914613 C126.327078,27.0719509 126.621296,29.4093815 127.734995,30.7501828 C128.44919,31.6120846 129.481584,32.0486246 130.801762,32.0486246 C132.942007,32.0486246 136.708931,31.043759 137.896916,24.3115121 C138.409311,21.4139926 138.102226,19.1895213 137.010754,17.8793131 L137.010754,17.8793131 L137.010754,17.8793131 Z M141.530477,14.4058197 C143.415694,16.6614724 144.005884,20.4909048 143.190498,25.1875337 C141.984965,32.1392273 137.004318,36.9941166 131.079017,36.9941166 C128.718257,36.9941166 126.795019,36.1139767 125.363119,34.3778185 L125.121546,34.0842423 L124.851895,35.6203689 C124.76591,36.1004451 124.400915,36.4228494 123.944675,36.4228494 L120.101125,36.4228494 C119.932081,36.4228494 119.764207,36.3422484 119.6519,36.2081093 C119.538424,36.0722055 119.492802,35.8968833 119.524387,35.7150898 L119.797548,34.1524884 L119.436649,34.4366512 C117.956201,35.606249 115.674988,37 113.217129,37 C111.541314,37 110.328764,36.55287 109.611059,35.6733184 C108.246426,33.9983462 108.823164,31.0984734 109.244896,28.981078 C109.310407,28.6498489 109.371825,28.3415645 109.419789,28.0638735 C109.607549,26.9895849 109.781858,26.0111942 109.940372,25.1216409 C110.856952,19.9890602 111.235984,17.8640165 110.525883,17.0103513 C110.28431,16.7203053 109.925748,16.5844013 109.397561,16.5844013 C105.822493,16.5844013 101.323241,26.2171092 98.7267543,35.7327397 C98.6045038,36.1775162 98.2623234,36.4228494 97.7633816,36.4228494 L94.224578,36.4228494 C94.0549496,36.4228494 93.8859056,36.34166 93.7730141,36.2069327 C93.6601246,36.0710288 93.6156703,35.89453 93.6490105,35.7097949 C93.7338247,35.2350134 94.2971095,31.9880267 94.2971095,31.9880267 C94.5088509,30.7843059 94.7270297,29.6070599 94.9381868,28.4739386 C95.9805265,22.8606933 96.8041011,18.4270472 95.6634958,17.0450629 C95.4108082,16.7397201 95.0703807,16.5844013 94.6509883,16.5844013 C91.9650073,16.5844013 87.5733831,24.4709492 83.9708228,35.7627445 C83.8158184,36.2498807 83.3753685,36.4228494 83.0460551,36.4228494 L79.4627973,36.4228494 C79.3019417,36.4228494 79.1369938,36.3393068 79.0211787,36.2004611 C78.9141365,36.0716172 78.8685116,35.9133567 78.8954183,35.7650978 C78.9164757,35.6456669 79.1627299,34.1842582 79.1627299,34.1842582 L78.8111904,34.4495945 C76.5007319,36.1892828 74.5488327,37 72.6682963,37 C70.9930678,37 69.781686,36.5640483 69.0651498,35.7062648 C68.245085,34.7237558 68.0333417,33.172921 68.4188076,30.9666879 L68.8282547,28.635729 L68.5053768,28.5133566 C66.3189219,32.1562888 62.8351022,37 57.8433432,37 C55.7054387,37 54.064721,35.9733661 53.3411669,34.1824932 L53.2551821,33.9689298 L53.0726866,34.1077754 C50.6177514,35.9833678 48.7500821,37 45.9155301,37 C44.2701319,37 43.0762977,36.5669899 42.3673675,35.7145015 C41.0623986,34.1448402 41.5455459,31.4449991 41.8976717,29.4735094 L41.9994491,28.8951821 C42.3398765,26.8813324 42.7855893,24.3462236 43.1880185,22.0582128 L43.524936,20.1432023 C43.7349244,18.9436 43.8530807,17.7410558 43.2962314,17.0744793 C43.0259942,16.7503101 42.6206414,16.5861662 42.0912831,16.5861662 C39.737541,16.5861662 33.7309332,23.9226267 29.2966098,35.8715853 C29.1954167,36.1451581 28.8754624,36.4228494 28.4595799,36.4228494 L25.4331715,36.4228494 C25.2050512,36.4228494 25.0646687,36.3122436 24.9868724,36.2192876 C24.8763221,36.087502 24.8242638,35.9057083 24.8511704,35.7456829 C24.9570421,35.1226427 28.3975781,15.5177611 30.0505785,6.09567498 L30.985876,0.76659246 C31.0508033,0.395945308 31.4187217,0 31.8644345,0 L36.1934726,0 C36.3648559,0 36.5204467,0.0741294265 36.6339225,0.208268407 C36.7491532,0.346525678 36.8012116,0.532437595 36.7713794,0.705406263 L33.1840273,20.9927493 L33.5115858,21.1062967 C33.5595499,21.0151057 38.3875297,11.9807282 44.411685,11.9807282 C46.3939988,11.9807282 47.829993,12.4978693 48.6810605,13.5174432 C49.9737467,15.068278 49.7427008,17.5310225 49.3970105,19.5036891 C49.017978,21.6669742 48.6336808,23.8273174 48.2932553,25.7440929 C48.0218494,27.2743361 47.7773503,28.6498489 47.5849094,29.7506121 C47.350938,31.0855302 47.4345836,31.9380188 47.8492955,32.435745 C48.1628162,32.8116871 48.6523989,32.9858324 49.3899907,32.9858324 C50.3393258,32.9858324 51.4600442,32.4992845 52.7205608,31.53972 L52.7948453,31.4826523 L52.7907511,31.3902846 C52.7392771,30.2883448 52.832866,29.0516776 53.0674218,27.7138177 C53.0674218,27.7138177 55.3995221,14.2863889 55.5235256,13.576276 C55.6136047,13.0620766 56.0476191,12.792622 56.4289909,12.792622 L60.7030469,12.792622 C60.9036762,12.792622 61.068626,12.8632215 61.1809312,12.9973605 C61.2908971,13.1279695 61.3441261,13.318588 61.3172194,13.4803784 L58.8423974,27.5885036 C58.819585,27.7161712 58.7938489,27.8556049 58.7651873,28.0032756 C58.5481791,29.1422802 58.250451,30.7037048 58.9295509,31.5291302 C59.2190886,31.8815391 59.6566149,32.0603912 60.2310118,32.0603912 C63.1456974,32.0603912 69.1651722,25.4393385 72.4208716,13.4674352 C72.4284757,13.4397837 72.6138967,12.790857 73.3216582,12.790857 L76.6288297,12.790857 C76.8154213,12.790857 76.9815398,12.8667515 77.0967706,13.0050087 C77.211417,13.1426777 77.262891,13.3244713 77.2330588,13.4909684 C76.7674572,16.1478613 74.3394286,29.9959453 74.3318245,30.0406583 C74.1224224,31.2926221 74.2089915,32.0933376 74.6032303,32.5622357 C74.881656,32.8928765 75.3121624,33.0534902 75.9198995,33.0534902 C77.103206,33.0534902 78.6023706,32.1745269 79.6101996,31.3526316 L79.6610873,31.3114486 L79.6722014,31.2461441 C80.4326055,26.9654636 81.4907359,20.9498013 82.1979111,16.9262204 L82.7875182,13.5756877 C82.8688225,13.1114963 83.2320604,12.799682 83.6894736,12.799682 L87.9962835,12.792622 C88.1758573,12.792622 88.3484093,12.8708698 88.4577909,13.0014788 C88.5665881,13.1309111 88.6063618,13.2985848 88.5741922,13.48685 C88.3261832,14.9276674 87.3879621,20.3279376 87.3879621,20.3279376 L87.7155205,20.441485 C87.83192,20.2214501 87.9629433,19.9637621 88.10742,19.677246 C89.4580157,17.0044681 91.9731977,12.0295595 96.5174889,12.0295595 C99.733997,12.0295595 101.403961,13.7757195 101.480586,17.2192082 C101.530305,19.4572111 101.204502,20.9668628 101.201576,20.9821593 L101.534984,21.0868819 C101.571834,20.9956909 105.282021,12.0283829 111.686377,12.0283829 C113.709051,12.0283829 115.018701,12.4743361 115.807766,13.4321355 C116.962996,14.8329465 117.099868,17.4698363 116.25465,21.9823184 C116.035889,23.150151 115.660366,25.3322626 115.328711,27.2578629 C115.166103,28.2033074 115.010512,29.1022738 114.885338,29.820035 C114.650782,31.1590713 114.735012,32.0156782 115.150895,32.5139927 C115.458566,32.8828748 115.93177,33.0534902 116.640702,33.0534902 C118.052713,33.0534902 119.385175,32.0250913 120.264904,31.2508507 L120.311698,31.2102559 L120.322225,31.1484815 C120.93289,27.6602798 124.979408,4.57484497 125.647394,0.781300693 C125.728114,0.32534585 126.098956,0.0064716146 126.548765,0.0064716146 L130.844463,0.0064716146 C131.034562,0.0064716146 131.199512,0.0788360571 131.308894,0.20944507 C131.420615,0.34299571 131.463314,0.524200996 131.428803,0.720702817 L131.241627,1.8020512 C130.791234,4.40834791 130.150739,8.10540627 129.325994,12.751439 C129.1938,13.49038 129.003114,14.5064239 129.003114,14.5064239 L128.900752,15.057688 L129.299087,14.6652727 C131.011752,12.9785339 133.356719,12.010733 135.732689,12.010733 C138.251381,12.010733 140.20211,12.8167435 141.530477,14.4058197 L141.530477,14.4058197 L141.530477,14.4058197 Z M177.37826,17.9552075 C176.623705,17.0444745 175.521118,16.5832246 174.102674,16.5832246 C170.626458,16.5832246 168.022366,19.3560184 167.137374,23.9996978 C166.803966,25.7476228 166.469388,28.9528382 167.970894,30.7807759 C168.663445,31.6238512 169.655479,32.0509779 170.920674,32.0509779 C174.458307,32.0509779 177.401656,28.9181268 178.246875,24.2550326 C178.758099,21.4351726 178.458034,19.2560026 177.37826,17.9552075 L177.37826,17.9552075 L177.37826,17.9552075 Z M235.768509,12.323724 L235.768509,15.6177771 C235.768509,15.832517 235.667902,15.968421 235.584843,16.0443155 C235.469026,16.1496264 235.312851,16.2072825 235.144977,16.2072825 C235.08356,16.2072825 235.021558,16.1996343 234.960727,16.1837495 C234.465879,16.054317 233.971032,15.9919541 233.449278,15.9919541 C229.762487,15.9919541 225.22931,20.1196693 225.038624,20.2955796 L224.936847,20.3891238 L225.002359,20.5103196 C225.002359,20.5103196 232.512809,34.3366354 233.165587,35.5515343 C233.266196,35.7386229 233.2621,35.951598 233.153889,36.1333917 C233.048017,36.3122436 232.862012,36.4228494 232.668985,36.4228494 L228.107732,36.4228494 C227.158397,36.4228494 227.096979,36.309302 226.695135,35.5680077 L226.426654,35.0743997 C224.884204,32.2345365 222.249697,27.3849419 220.597865,24.3291619 L220.493162,24.1356018 L219.370691,25.1139926 C218.899824,25.5228813 218.627834,25.7593895 218.212536,26.1335666 L218.168082,26.1747495 C218.168082,26.1747495 217.514134,29.9418191 217.248579,31.4779457 C216.894112,33.5282715 216.625632,35.0814596 216.520344,35.6591985 C216.428512,36.1598664 215.998006,36.4228494 215.61956,36.4228494 L211.30222,36.4228494 C211.1361,36.4228494 210.97466,36.3446017 210.859431,36.2069327 C210.744784,36.068087 210.695652,35.8951184 210.724311,35.7303864 L211.53268,31.1614246 L211.174705,31.4332327 C206.676038,34.8661314 202.890396,36.9941166 197.925544,36.9941166 C193.747416,36.9941166 190.527398,35.6021307 189.090235,33.1735093 L188.969155,32.9687709 L188.808886,33.1458578 C188.77496,33.1840991 185.281196,37 181.022933,37 C178.960484,37 176.97466,36.5969947 176.422489,33.6777071 L176.358148,33.3405946 L176.123008,33.5882811 C173.948253,35.8809985 171.51145,36.9941166 168.67222,36.9941166 C165.785609,36.9941166 163.452338,35.561536 162.431642,33.162331 L162.334545,32.933471 L162.152048,33.1023215 C160.222961,34.879663 157.204157,37 153.774151,37 C151.348461,37 149.572626,36.3457783 148.496948,35.0561616 C147.458703,33.811846 147.094294,31.9450786 147.470987,29.798855 L149.565608,17.8551915 C149.672649,17.2421529 149.759802,16.7938465 149.759802,16.7932581 L149.801917,16.5832246 L146.070088,16.5832246 C145.923272,16.5832246 145.764758,16.5026236 145.656547,16.374368 C145.54073,16.2361107 145.492768,16.0602004 145.523769,15.878995 C145.644262,15.1518207 145.935555,13.4880267 145.936141,13.4880267 C146.008086,13.0720782 146.449705,12.792622 146.817039,12.792622 L150.451771,12.792622 L151.969069,4.14889489 C152.045695,3.71470822 152.427067,3.38700906 152.856403,3.38700906 L157.174327,3.38700906 C157.346294,3.38700906 157.509489,3.46643346 157.624134,3.60469073 C157.73527,3.73765305 157.784989,3.90826841 157.758083,4.06064557 C157.582605,5.04727301 156.267106,12.5855303 156.267106,12.5855303 L156.231425,12.792622 L162.190653,12.792622 C162.367886,12.792622 162.528739,12.8679281 162.64397,13.0044204 C162.753352,13.1367944 162.804239,13.3079981 162.776748,13.4633169 C162.703633,13.8775004 162.380755,15.7766259 162.380755,15.7766259 C162.283071,16.3331849 161.834433,16.5832246 161.432588,16.5832246 L155.573383,16.5832246 L153.292172,29.5382255 C153.085694,30.7195897 153.245963,31.6356178 153.768886,32.262188 C154.187694,32.7652091 154.844566,33.0534902 155.568704,33.0534902 C158.375765,33.0534902 160.292567,31.7109237 161.489327,30.7007632 L161.565951,30.6366354 L161.550158,30.5377962 C161.30098,29.0016697 161.096255,27.4567181 161.329642,25.4516934 C162.084781,18.9636031 165.854631,12.0295595 174.170524,12.0295595 C177.977224,12.0295595 179.334837,14.4152329 179.568223,14.8935442 L179.802194,15.3730323 L180.140865,13.5209731 C180.199358,13.1350294 180.61056,12.7890921 181.004801,12.7890921 L184.865314,12.7890921 C185.039037,12.7890921 185.197551,12.8638098 185.310442,12.9991254 C185.423334,13.1350294 185.474222,13.3174113 185.443805,13.4850851 L182.587027,29.81827 C182.328488,31.2920338 182.386398,32.1233424 182.781223,32.5957704 C183.041514,32.908173 183.440434,33.0534902 184.037059,33.0534902 C186.20538,33.0534902 187.794039,30.8554937 187.86072,30.7619494 L187.90927,30.6931149 L187.887042,30.6119255 C187.438988,28.9910797 187.369382,26.32948 187.722092,24.2838608 C189.025308,16.7256002 193.944537,12.0295595 200.560051,12.0295595 C203.749654,12.0295595 206.23442,13.0103037 207.745283,14.8647163 C209.301772,16.7756081 209.507667,19.2095246 209.181277,20.8503736 C209.071895,21.3998729 208.546047,21.8464144 208.0085,21.8464144 L204.112308,21.8464144 C203.937414,21.8464144 203.777145,21.7740498 203.660744,21.6410876 C203.550194,21.5145969 203.49638,21.3492764 203.515683,21.1980761 L203.65314,20.1384958 C203.789428,19.1036254 203.571251,18.2234855 203.023761,17.594562 C202.447023,16.9332804 201.545652,16.5832246 200.417329,16.5832246 C197.104893,16.5832246 194.278529,19.6737159 193.383592,24.2744474 C192.903368,26.7466052 193.21455,28.678677 194.310116,30.0171251 C195.420305,31.3726348 197.32073,32.0603912 199.959332,32.0603912 C204.988527,32.0603912 208.460064,30.2248053 212.123455,27.4684847 L212.178439,27.4267133 L216.845564,0.81542375 C216.937982,0.312990942 217.30239,0 217.795485,0 L222.06369,0.00235332498 C222.237999,0.00235332498 222.400607,0.0788360571 222.511744,0.211210054 C222.626388,0.348879003 222.672013,0.528907626 222.638673,0.715996186 C222.380721,2.19505487 222.007537,4.31303864 221.572352,6.78696135 C220.856402,10.8499602 219.971994,15.8719352 219.150757,20.5920973 L219.051321,21.1633645 L219.45024,20.7444745 C221.053522,19.061854 223.993945,15.9760692 227.459049,13.3674193 C230.144443,11.3447448 232.30516,10.9199714 233.644642,10.9199714 C234.994067,10.9199714 235.768509,11.4318175 235.768509,12.323724 L235.768509,12.323724 L235.768509,12.323724 Z M27.3488049,4.40599459 C27.5552834,3.22933695 27.8471623,1.5755446 27.9577126,0.973095883 C27.9863742,0.816012091 27.9372414,0.642455081 27.8266892,0.508904442 C27.7126291,0.370647171 27.5476792,0.291811095 27.3745409,0.291811095 L10.5351045,0.291811095 C3.29664367,0.291811095 0,4.8490062 0,9.0837971 C0,9.49621561 0.0339245235,10.5152011 0.352125792,11.051757 C0.535207522,11.3623947 0.814801831,11.53301 1.13826602,11.53301 C1.22132527,11.53301 1.30789442,11.5218318 1.39563418,11.4994753 C1.79279854,11.400636 2.45142529,11.2311973 3.14222355,11.0546987 L3.93070307,10.8523136 C4.04300826,10.8234854 4.40858738,10.7011131 4.40858738,10.3281126 C4.40858738,7.98068055 5.50590908,5.18317697 10.7351494,5.18317697 L13.4778674,5.18317697 L8.07198078,36.0157258 C8.04331918,36.180458 8.09245198,36.354015 8.20826707,36.4922721 C8.32291349,36.6299411 8.4831828,36.7081888 8.64988758,36.7081888 L12.9678116,36.7081888 C13.3462577,36.7081888 13.7767642,36.4457943 13.8680119,35.9457148 L19.2551823,5.18317697 L26.4614716,5.18317697 C26.8966566,5.18317697 27.2704242,4.85547781 27.3488049,4.40599459 L27.3488049,4.40599459 L27.3488049,4.40599459 Z" fill="#000000"></path>
                    </g>
                </svg>
                <div :class="marqueeClass">{{ marqueeMessage }}</div>
            </div>
            <star class="slot-machine__marquee__star"></star>
        </div>
        <div class="slot-machine__body">
            <div class="slot-machine__reels row">
                <slot-reel v-for="(index, reel) in machine.reels"
                    track-by="$index"
                    :reel-index="index"
                    :symbols="reel">
                </slot-reel>
            </div>
            <div class="spin-button">
                <button @click="spinReels" :disabled="isSpinning || isGameOver">Spin!</button>
            </div>
        </div>
        <div class="slot-machine__footer row">
            <div class="slot-machine__footer__entry col-xs-12 col-md-6 col-lg-4">
                <settings-button @click="showSettings = true"></settings-button>
                <metric class="spin-metric" label="Spins" :value="spins"></metric>
            </div>
            <metric class="slot-machine__footer__entry col-xs-12 col-md-6 col-lg-4 last-win-metric" label="Last Win" :value="lastWin"></metric>
            <div class="slot-machine__footer__entry col-xs-12 col-md-6 col-lg-4">
                <metric label="Bet" :value="bet" class="bet-metric"></metric>
                <div class="bet-buttons">
                    <arrow direction="up"
                        class="bet-button bet-button--up"
                        :disabled="isSpinning"
                        @click="increaseBet">
                    </arrow>
                    <arrow direction="down"
                        class="bet-button bet-button--down"
                        :disabled="isSpinning"
                        @click="decreaseBet">
                    </arrow>
                </div>
            </div>
        </div>
        <prize-modal :show.sync="showPrize"
            :prize-category="prizeCategory">
        </prize-modal>
        <game-over-modal :show.sync="showGameOver"></game-over-modal>
        <settings-modal :enable-sound.sync="enableSound"
            :enable-music.sync="enableMusic"
            :symbols-per-reel.sync="symbolsPerReel"
            :show.sync="showSettings">
        </settings-modal>
        <!-- Sounds -->
        <audio class="intro-sound" src="/espresso-slots/static/audio/intro.mp3"></audio>
        <audio class="jackpot-sound" src="/espresso-slots/static/audio/jackpot.mp3"></audio>
        <audio class="coin-sound" src="/espresso-slots/static/audio/coin.mp3"></audio>
        <audio class="banana-sound" src="/espresso-slots/static/audio/banana.mp3"></audio>
        <audio class="star-sound" src="/espresso-slots/static/audio/star.mp3"></audio>
        <audio class="game-over-sound" src="/espresso-slots/static/audio/game_over.mp3"></audio>
    </div>
</template>

<script>
    import SlotMachineModel from "../models/SlotMachine";
    import SlotReel from "./SlotReel.vue";
    import Metric from "./Metric.vue";
    import Star from "./Star.vue";
    import Arrow from "./Arrow.vue";
    import Modal from "./Modal.vue";
    import SettingsButton from "./SettingsButton.vue";
    import SettingsModal from "./SettingsModal.vue";
    import GameOverModal from "./GameOverModal.vue";
    import PrizeModal from "./PrizeModal.vue";

    export default {
        components: {
            SlotReel,
            Metric,
            Star,
            Arrow,
            Modal,
            SettingsButton,
            SettingsModal,
            GameOverModal,
            PrizeModal
        },

        props: ['reels', 'symbolsPerReel'],
        data() {
            let machine = new SlotMachineModel(this.reels.slice(0));
            return {
                machine,
                spin: machine.spin(),
                isSpinning: false,
                isJackpot: false,
                marqueeIsLit: false,
                prizeCategory: { icon: '', prize: '' },
                showPrize: false,
                showGameOver: false,
                showSettings: false,
                enableSound: true,
                enableMusic: true,
                spins: 10,
                bet: 1,
                lastWin: 0
            };
        },
        methods: {
            spinReels(e) {
                this.isSpinning = true;
                this.isJackpot = false;
                this.marqueeIsLit = false;
                this.animate(".spin-button", "pulse");
                this.playMusic(".star-sound");
                this.$broadcast('on-spin');
            },
            increaseBet(e) {
                this.playSound(".coin-sound");
                this.bet = Math.min(this.spins, this.bet + 1);
            },
            decreaseBet(e) {
                this.playSound(".banana-sound");
                this.bet = Math.max(1, this.bet - 1);
            },

            // animate the tallying of a jackpot
            animateMetric(metricName, targetValue) {
                if (this[metricName] !== targetValue) {
                    this[metricName]++;
                    setTimeout(() => this.animateMetric(metricName, targetValue), 200);
                }
            },
            playSound(selector) {
                if (this.enableSound) {
                    let sound = new Audio(this.$el.querySelector(selector).src);
                    sound.play();
                }
            },
            playMusic(selector) {
                if (this.enableMusic) {
                    this.$el.querySelector(selector).play();
                }
            },
            stopMusic(selector) {
                let sound = this.$el.querySelector(selector);
                sound.pause();
                sound.currentTime = 0;
            },
            animate(selector, animation) {
                $(this.$el).find(selector).animateCss(animation);
            },
            scoreWinAndCelebrate() {
                this.playSound(".jackpot-sound");
                let lastWin = this.machine.scoreForSpin(this.spin, this.bet);
                this.prizeCategory = this.spin[0].category;

                // Perform celebratory animations
                this.animateMetric("lastWin", lastWin);
                this.animateMetric("spins", this.spins + lastWin);
                this.animate(".last-win-metric", "pulse");
                this.animate(".spin-metric", "pulse");
                this.animate(".slot-machine__marquee", "rubberBand");
                this.marqueeIsLit = true;
                setTimeout(() => this.showPrize = true, 1000);
            },
            scoreLossAndSulk() {
                this.spins -= this.bet;
                this.bet = Math.min(this.bet, this.spins);
                if (this.isGameOver) {
                    this.playSound(".game-over-sound");
                    setTimeout(() => this.showGameOver = true, 1000);
                } else {
                    this.playSound(".banana-sound");
                }
            },
            loadNextSpin() {
                this.spin = this.machine.spin();
                this.$broadcast('on-next-spin-load', this.spin);
            }
        },
        computed: {
            isGameOver() {
                return this.spins === 0;
            },
            marqueeMessage() {
                if (this.isGameOver) {
                    return "GAME OVER!";
                } else if (this.isJackpot) {
                    return "JACKPOT!";
                }
                return "SLOTS!";
            },
            marqueeClass() {
                return {
                    'neon': this.marqueeIsLit
                };
            }
        },
        events: {
            'on-reel-spin-complete': function(reelIndex) {
                if (reelIndex === this.machine.reels.length - 1) {
                    // The last reel finished spinning, so figure out if it's a win
                    this.stopMusic(".star-sound");
                    this.isSpinning = false;
                    this.isJackpot = this.machine.isJackpot(this.spin);
                    this.isJackpot ?  this.scoreWinAndCelebrate() : this.scoreLossAndSulk(); 

                    this.loadNextSpin();
                } else {
                    let selector = this.machine.spinLooksPromisingAtIndex(this.spin, reelIndex) ?
                        ".coin-sound" : ".banana-sound";
                    this.playSound(selector);
                }
            }
        },
        watch: {
            symbolsPerReel: function(newValue) {
                let reels = this.reels.map(reel => reel.slice(0, parseInt(newValue)));
                this.machine = new SlotMachineModel(reels);
                this.$nextTick(function() { this.loadNextSpin(); });
            }
        },
        ready() {
            this.animate(".slot-machine__marquee", "tada");
            this.playSound(".intro-sound");
            this.$broadcast('on-next-spin-load', this.spin);
        }
    }
</script>

<style lang="sass">
    @import '../stylesheets/variables.scss';
    @import '../stylesheets/utilities.scss';

    .slot-machine {
        display: flex;
        flex-direction: column;
        margin: 30px 0;
        background-color: $purple;
        @include rounded-black-border(4px, 30px);
        overflow: hidden;
    }

    .slot-machine__marquee {
        display: flex;
        justify-content: center;
        align-items: center;
        text-align: center;
        color: black;
        padding: 20px 0;
        margin-top: 20px;
    }

    .slot-machine__marquee__star {
        @media (max-width: $screen-sm) {
            & {
                display: none;
            }
        }
    }

    .slot-machine__marquee__message {
        display: flex;
        flex-direction: column;
        align-items: center;
        font-size: 7vw;
        line-height: 100%;
        margin: 0 30px;

        @media (max-width: $screen-sm) {
            & {
                font-size: 11vw;
                margin: 0 20px;
            }
        }

        @media (max-width: $screen-xs) {
            & {
                font-size: 13vw;
                margin: 0;
            }
        }
    }

    .slot-machine__marquee__message > svg {
        width: 250px;
        z-index: 1;

        @media (max-width: $screen-sm) {
            & {
                width: 200px;
            }
        }
    }

    .slot-machine__body {
        margin: 0px auto;
        padding: 10px;
    }
    .slot-machine__reels {
        display: flex;
    }
    .neon {
        text-shadow: 0 0 10px  white,
                     0 0 20px  white,
                     0 0 30px  white,
                     0 0 40px  $yellow,
                     0 0 70px  $yellow,
                     0 0 80px  $yellow,
                     0 0 100px $yellow,
                     0 0 150px $yellow;
    }
    .spin-button {
        text-align: center;
        margin: 10px 0px;
    }
    .spin-button > button {
        border: none;
        font-size: 50px;
        margin: 0px auto;
        color: white;
        border-radius: 10px;
        padding: 0px 50px;
        @include button-styles($green);
    }
    .slot-machine__footer {
        background-color: $black;
        border-top: 4px solid $yellow;
        padding: 20px;
    }
    .slot-machine__footer__entry {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px 0;
    }
    .bet-buttons {
        display: flex;
        flex-direction: column;
        justify-content: center;
        margin-left: 15px;
    }
    .bet-button--up {
        margin-bottom: 10px;
    }
</style>
